<!-- ============================================================================ -->
<!-- ANDES SIMPLIFIED ONBOARDING - COMPLETE HTML INTEGRATION -->
<!-- ============================================================================ -->
<!-- Add this to your index.html file before the closing </body> tag -->

<!-- Andes Simplified Onboarding System -->
<script>
// ============================================================================
// ANDES SIMPLIFIED ONBOARDING - INLINE VERSION
// ============================================================================
// Complete frontend system for direct-to-WhatsApp onboarding flow

(function() {
  'use strict';
  
  // Configuration
  const CONFIG = {
    API_BASE_URL: 'https://v3-production-2670.up.railway.app',
    FALLBACK_URL: '/start',
    DEFAULT_LANGUAGE: 'es',
    ANALYTICS_ENABLED: true,
    DEBUG_MODE: false, // Set to true for development
    RETRY_ATTEMPTS: 2,
    TIMEOUT_MS: 10000
  };

  // Utility functions
  const log = (...args) => {
    if (CONFIG.DEBUG_MODE) {
      console.log('[Andes Onboarding]', ...args);
    }
  };

  const error = (...args) => {
    console.error('[Andes Onboarding Error]', ...args);
  };

  // Language detection
  function getLanguage() {
    // Check URL path
    if (window.location.pathname.includes('/en')) return 'en';
    if (window.location.pathname.includes('/es')) return 'es';
    
    // Check browser language
    const browserLang = navigator.language.toLowerCase();
    if (browserLang.startsWith('en')) return 'en';
    
    return CONFIG.DEFAULT_LANGUAGE;
  }

  // Analytics tracking
  function trackEvent(event, intent, language, metadata = {}) {
    if (!CONFIG.ANALYTICS_ENABLED) return;
    
    try {
      const eventData = {
        event,
        intent,
        language,
        timestamp: new Date().toISOString(),
        url: window.location.href,
        userAgent: navigator.userAgent,
        metadata
      };

      log('Tracking event:', eventData);

      // Send to backend analytics
      fetch(`${CONFIG.API_BASE_URL}/onboarding/analytics`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(eventData)
      }).catch(e => log('Analytics failed:', e));

      // Send to Google Analytics if available
      if (typeof gtag !== 'undefined') {
        gtag('event', event, {
          'custom_parameter_intent': intent,
          'custom_parameter_language': language
        });
      }

    } catch (e) {
      error('Analytics error:', e);
    }
  }

  // Button state management
  function updateButtonState(button, state, text, disabled = false) {
    if (!button) return;
    
    const textElement = button.querySelector('.btn-text');
    if (textElement) {
      textElement.textContent = text;
    } else {
      button.innerHTML = text;
    }
    
    button.disabled = disabled;
    button.classList.remove('loading', 'success', 'error');
    if (state) button.classList.add(state);
  }

  // Main onboarding function
  async function startTraining(intent, retryCount = 0) {
    const language = getLanguage();
    const button = document.getElementById(`start-${intent}-btn`);
    
    if (!button) {
      error(`Button not found: start-${intent}-btn`);
      return;
    }

    const originalText = button.querySelector('.btn-text')?.textContent || button.textContent;
    const loadingTexts = {
      free: {
        es: 'ðŸ”„ Preparando entrenamiento gratuito...',
        en: 'ðŸ”„ Preparing free training...'
      },
      premium: {
        es: 'ðŸ”„ Activando Andes Premium...',
        en: 'ðŸ”„ Activating Andes Premium...'
      }
    };

    try {
      // Update button to loading state
      updateButtonState(button, 'loading', loadingTexts[intent][language], true);
      
      // Track start event
      trackEvent('onboarding_start_clicked', intent, language, { retryCount });

      log(`Starting ${intent} onboarding (attempt ${retryCount + 1})`);

      // Create abort controller for timeout
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), CONFIG.TIMEOUT_MS);

      // Call simplified API
      const response = await fetch(`${CONFIG.API_BASE_URL}/onboarding/start`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ intent, language }),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      const data = await response.json();
      log('API response:', data);

      if (data.success && data.whatsappLink) {
        // Success - show confirmation and redirect
        const successText = language === 'es' 
          ? 'âœ… Redirigiendo a WhatsApp...' 
          : 'âœ… Redirecting to WhatsApp...';
        
        updateButtonState(button, 'success', successText, true);
        
        // Track success
        trackEvent('onboarding_redirect_success', intent, language);

        // Redirect after brief delay
        setTimeout(() => {
          log('Redirecting to WhatsApp:', data.whatsappLink);
          window.location.href = data.whatsappLink;
        }, 1500);

      } else {
        throw new Error(data.error || 'API returned unsuccessful response');
      }

    } catch (error) {
      error('Simplified onboarding failed:', error);
      
      // Track error
      trackEvent('onboarding_error', intent, language, {
        error: error.message,
        retryCount
      });

      // Retry logic
      if (retryCount < CONFIG.RETRY_ATTEMPTS && error.name !== 'AbortError') {
        log(`Retrying... (${retryCount + 1}/${CONFIG.RETRY_ATTEMPTS})`);
        setTimeout(() => startTraining(intent, retryCount + 1), 1000);
        return;
      }

      // Fallback to existing /start page
      log('Using fallback to /start page');
      
      const fallbackText = language === 'es' 
        ? 'ðŸ”„ Redirigiendo al formulario...' 
        : 'ðŸ”„ Redirecting to form...';
      
      updateButtonState(button, 'loading', fallbackText, true);
      
      trackEvent('onboarding_fallback_used', intent, language);

      setTimeout(() => {
        window.location.href = `${CONFIG.FALLBACK_URL}?flow=${intent}`;
      }, 1000);
    }
  }

  // Initialize system
  function init() {
    log('Initializing Andes Simplified Onboarding System');
    
    // Add event listeners to buttons
    const freeBtn = document.getElementById('start-free-btn');
    const premiumBtn = document.getElementById('start-premium-btn');

    if (freeBtn) {
      freeBtn.addEventListener('click', (e) => {
        e.preventDefault();
        startTraining('free');
      });
      log('Free button initialized');
    }

    if (premiumBtn) {
      premiumBtn.addEventListener('click', (e) => {
        e.preventDefault();
        startTraining('premium');
      });
      log('Premium button initialized');
    }

    // Track page load
    trackEvent('onboarding_page_loaded', 'unknown', getLanguage());
  }

  // Auto-initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Expose global functions
  window.andesStartTraining = startTraining;

  log('Andes Simplified Onboarding System loaded');

})();
</script>

<!-- Optional: External script version -->
<!-- <script src="/js/andes-simplified-onboarding.js"></script> -->

<!-- ============================================================================ -->
<!-- INTEGRATION NOTES -->
<!-- ============================================================================ -->
<!--
1. Make sure your buttons have the correct IDs:
   - Free plan button: id="start-free-btn"
   - Premium plan button: id="start-premium-btn"

2. The script will automatically:
   - Detect language from URL (/es/ = Spanish, otherwise English)
   - Handle loading states and user feedback
   - Retry failed requests automatically
   - Fallback to /start page if simplified flow fails
   - Track analytics events

3. For debugging, set CONFIG.DEBUG_MODE = true in the script

4. The system integrates with:
   - Google Analytics (gtag)
   - Facebook Pixel (fbq)
   - Custom backend analytics

5. WhatsApp messages are pre-filled with appropriate content for each intent
-->
